source("packages.R")
# Daily “what’s on” schedule for:
# EPL, Bundesliga, UEFA Champions League, MLB, NBA, NFL, NHL
# using TheSportsDB day endpoint.
#
# install.packages(c("httr2","jsonlite","dplyr","purrr","stringr","lubridate","tibble"))
library(httr2)
library(jsonlite)
library(dplyr)
library(purrr)
library(stringr)
library(lubridate)
library(tibble)
API_KEY <- "123"
TZ_OUT  <- "America/Los_Angeles"
base_url <- function(path) sprintf("https://www.thesportsdb.com/api/v1/json/%s/%s", API_KEY, path)
tsdb_get <- function(path, query = list()) {
req  <- request(base_url(path)) |> req_url_query(!!!query)
resp <- req |> req_perform()
fromJSON(resp_body_string(resp), flatten = TRUE)
}
# ---- choose “today” in your timezone
day_local <- as.Date(with_tz(Sys.time(), TZ_OUT))
day_str   <- format(day_local, "%Y-%m-%d")
# ---- fetch all events for a given sport on a given day
get_events_day_sport <- function(day_yyyy_mm_dd, sport) {
x <- tsdb_get("eventsday.php", query = list(d = day_yyyy_mm_dd, s = sport))
if (is.null(x$events)) return(tibble())
as_tibble(x$events) |>
mutate(request_sport = sport)
}
# Pull all sports that cover your leagues
sports_to_pull <- c("Soccer", "Baseball", "Basketball", "American Football", "Ice Hockey")
raw <- map_dfr(sports_to_pull, ~get_events_day_sport(day_str, .x))
if (nrow(raw) == 0) {
stop("No events returned by TheSportsDB for ", day_str, ".")
}
# ---- keep only the leagues you want (by league name in payload)
# NOTE: TheSportsDB league naming varies; these patterns are intentionally tolerant.
keep_league <- function(x) {
x <- str_to_lower(str_squish(x))
str_detect(x, "premier league") |
str_detect(x, "bundesliga") |
str_detect(x, "uefa.*champions league|champions league") |
str_detect(x, "\\bnfl\\b|national football league") |
str_detect(x, "\\bnba\\b|national basketball association") |
str_detect(x, "\\bnhl\\b|national hockey league") |
str_detect(x, "\\bmlb\\b|major league baseball")
}
raw <- raw |>
mutate(strLeague = if ("strLeague" %in% names(raw)) strLeague else NA_character_) |>
filter(!is.na(strLeague) & keep_league(strLeague))
# ---- parse datetime robustly
# prefer strTimestamp (UTC) if present; else dateEvent + strTime
dt_utc <- NULL
if ("strTimestamp" %in% names(raw)) {
dt_utc <- ymd_hms(raw$strTimestamp, tz = "UTC", quiet = TRUE)
}
if (is.null(dt_utc) || all(is.na(dt_utc))) {
if (all(c("dateEvent", "strTime") %in% names(raw))) {
dt_utc <- ymd_hms(paste(raw$dateEvent, raw$strTime), tz = "UTC", quiet = TRUE)
} else {
dt_utc <- as.POSIXct(NA)
}
}
dt_local <- with_tz(dt_utc, TZ_OUT)
schedule_today <- tibble(
league   = raw$strLeague,
sport    = if ("strSport" %in% names(raw)) raw$strSport else raw$request_sport,
datetime = dt_local,
date     = as.Date(dt_local),
time     = ifelse(is.na(dt_local), NA_character_, format(dt_local, "%H:%M")),
home     = if ("strHomeTeam" %in% names(raw)) raw$strHomeTeam else NA_character_,
away     = if ("strAwayTeam" %in% names(raw)) raw$strAwayTeam else NA_character_,
event    = coalesce(
if ("strEvent" %in% names(raw)) raw$strEvent else NA_character_,
paste(home, "vs", away)
),
venue    = if ("strVenue" %in% names(raw)) raw$strVenue else NA_character_
) |>
arrange(league, datetime, event)
print(schedule_today, n = 200)
# Optional export:
# install.packages("writexl")
# writexl::write_xlsx(schedule_today, paste0("schedule_", day_str, ".xlsx"))
View(schedule_today)
#sportsScheduler Interface
#January 2026
#J Stalnaker
#Load requisite packages
source("packages.R")
# install.packages(c("httr2","jsonlite","dplyr","purrr","stringr","lubridate","tibble"))
library(httr2)
library(jsonlite)
library(dplyr)
library(purrr)
library(stringr)
library(lubridate)
library(tibble)
API_KEY <- "123"
TZ_OUT  <- "America/Los_Angeles"
base_url <- function(path) sprintf("https://www.thesportsdb.com/api/v1/json/%s/%s", API_KEY, path)
tsdb_get <- function(path, query = list()) {
req  <- request(base_url(path)) |> req_url_query(!!!query)
resp <- req |> req_perform()
fromJSON(resp_body_string(resp), flatten = TRUE)
}
# --- choose "today" in your timezone
today_local <- as.Date(with_tz(Sys.time(), TZ_OUT))
# Pull adjacent API days to cover UTC<->local boundary
api_days <- c(today_local - 1, today_local, today_local + 1) |> format("%Y-%m-%d")
sports_to_pull <- c("Soccer", "Baseball", "Basketball", "American Football", "Ice Hockey")
get_events_day_sport <- function(day_yyyy_mm_dd, sport) {
x <- tsdb_get("eventsday.php", query = list(d = day_yyyy_mm_dd, s = sport))
if (is.null(x$events)) return(tibble())
as_tibble(x$events) |>
mutate(api_day = day_yyyy_mm_dd, request_sport = sport)
}
raw <- map_dfr(api_days, \(d) map_dfr(sports_to_pull, \(s) get_events_day_sport(d, s)))
if (nrow(raw) == 0) stop("No events returned by TheSportsDB for these days: ", paste(api_days, collapse = ", "))
# --- keep only the leagues you asked for (tolerant matching)
keep_league <- function(x) {
x <- str_to_lower(str_squish(x))
str_detect(x, "premier league") |
str_detect(x, "bundesliga") |
str_detect(x, "uefa.*champions league|\\bchampions league\\b") |
str_detect(x, "\\bnfl\\b|national football league") |
str_detect(x, "\\bnba\\b|national basketball association") |
str_detect(x, "\\bnhl\\b|national hockey league") |
str_detect(x, "\\bmlb\\b|major league baseball")
}
raw <- raw |>
mutate(strLeague = if ("strLeague" %in% names(raw)) strLeague else NA_character_) |>
filter(!is.na(strLeague) & keep_league(strLeague))
# --- parse datetime (prefer UTC timestamp if present)
dt_utc <- NULL
if ("strTimestamp" %in% names(raw)) {
dt_utc <- ymd_hms(raw$strTimestamp, tz = "UTC", quiet = TRUE)
}
if (is.null(dt_utc) || all(is.na(dt_utc))) {
# fallback: dateEvent + strTime (assume UTC if that's all we have)
dt_utc <- ymd_hms(paste(raw$dateEvent, raw$strTime), tz = "UTC", quiet = TRUE)
}
dt_local <- with_tz(dt_utc, TZ_OUT)
date_local <- as.Date(dt_local)
schedule_today <- tibble(
league   = raw$strLeague,
sport    = if ("strSport" %in% names(raw)) raw$strSport else raw$request_sport,
datetime = dt_local,
date     = date_local,
time     = format(dt_local, "%H:%M"),
home     = if ("strHomeTeam" %in% names(raw)) raw$strHomeTeam else NA_character_,
away     = if ("strAwayTeam" %in% names(raw)) raw$strAwayTeam else NA_character_,
event    = coalesce(if ("strEvent" %in% names(raw)) raw$strEvent else NA_character_,
paste(home, "vs", away)),
venue    = if ("strVenue" %in% names(raw)) raw$strVenue else NA_character_
) |>
filter(date == today_local) |>              # <-- THIS is the key fix
distinct(league, datetime, event, .keep_all = TRUE) |>
arrange(league, datetime, event)
print(schedule_today, n = 500)
# Optional export:
# install.packages("writexl")
# writexl::write_xlsx(schedule_today, paste0("schedule_", format(today_local, "%Y-%m-%d"), ".xlsx"))
View(schedule_today)
#sportsScheduler Interface
#January 2026
#J Stalnaker
#Load requisite packages
source("packages.R")
# install.packages(c("httr2","jsonlite","dplyr","purrr","stringr","lubridate","tibble"))
library(httr2)
library(jsonlite)
library(dplyr)
library(purrr)
library(stringr)
library(lubridate)
library(tibble)
API_KEY <- "123"
TZ_OUT  <- "America/Los_Angeles"
base_url <- function(path) sprintf("https://www.thesportsdb.com/api/v1/json/%s/%s", API_KEY, path)
tsdb_get <- function(path, query = list()) {
req  <- request(base_url(path)) |> req_url_query(!!!query)
resp <- req |> req_perform()
fromJSON(resp_body_string(resp), flatten = TRUE)
}
# --- today in your timezone
today_local <- as.Date(with_tz(Sys.time(), TZ_OUT))
today_str   <- format(today_local, "%Y-%m-%d")
# Pull adjacent API days to avoid UTC boundary issues
api_days <- c(today_local - 1, today_local, today_local + 1) |> format("%Y-%m-%d")
sports_to_pull <- c("Soccer", "Baseball", "Basketball", "American Football", "Ice Hockey")
get_events_day_sport <- function(day_yyyy_mm_dd, sport) {
x <- tsdb_get("eventsday.php", query = list(d = day_yyyy_mm_dd, s = sport))
if (is.null(x$events)) return(tibble())
as_tibble(x$events) |>
mutate(api_day = day_yyyy_mm_dd, request_sport = sport)
}
raw <- map_dfr(api_days, \(d) map_dfr(sports_to_pull, \(s) get_events_day_sport(d, s)))
if (nrow(raw) == 0) stop("No events returned by TheSportsDB for: ", paste(api_days, collapse = ", "))
# --- keep only your leagues (tolerant matching)
keep_league <- function(x) {
x <- str_to_lower(str_squish(x))
str_detect(x, "premier league") |
str_detect(x, "bundesliga") |
str_detect(x, "uefa.*champions league|\\bchampions league\\b") |
str_detect(x, "\\bnfl\\b|national football league") |
str_detect(x, "\\bnba\\b|national basketball association") |
str_detect(x, "\\bnhl\\b|national hockey league") |
str_detect(x, "\\bmlb\\b|major league baseball")
}
raw <- raw |>
mutate(strLeague = if ("strLeague" %in% names(raw)) strLeague else NA_character_) |>
filter(!is.na(strLeague) & keep_league(strLeague))
if (nrow(raw) == 0) stop("No matching league events found for: ", today_str)
# --- Parse event datetime as UTC, then convert to TZ_OUT
# TheSportsDB is inconsistent; prefer strTimestamp, else dateEvent+strTime.
dt_utc <- rep(as.POSIXct(NA, tz = "UTC"), nrow(raw))
if ("strTimestamp" %in% names(raw)) {
tmp <- ymd_hms(raw$strTimestamp, tz = "UTC", quiet = TRUE)
dt_utc[!is.na(tmp)] <- tmp[!is.na(tmp)]
}
if (all(is.na(dt_utc)) && all(c("dateEvent", "strTime") %in% names(raw))) {
tmp <- ymd_hms(paste(raw$dateEvent, raw$strTime), tz = "UTC", quiet = TRUE)
dt_utc <- tmp
}
# convert to your timezone
dt_local <- with_tz(dt_utc, TZ_OUT)
# CRITICAL: compute local date using explicit tz
date_local <- as.Date(dt_local, tz = TZ_OUT)
schedule_today <- tibble(
league   = raw$strLeague,
sport    = if ("strSport" %in% names(raw)) raw$strSport else raw$request_sport,
datetime = dt_local,
date     = date_local,
time     = ifelse(is.na(dt_local), NA_character_, format(dt_local, "%H:%M")),
home     = if ("strHomeTeam" %in% names(raw)) raw
View(raw)
View(raw)
#sportsScheduler Interface
#January 2026
#J Stalnaker
#Load requisite packages
source("packages.R")
# install.packages(c("httr2","jsonlite","dplyr","purrr","stringr","lubridate","tibble"))
library(httr2)
library(jsonlite)
library(dplyr)
library(purrr)
library(stringr)
library(lubridate)
library(tibble)
API_KEY <- "123"
TZ_OUT  <- "America/Los_Angeles"
base_url <- function(path) sprintf("https://www.thesportsdb.com/api/v1/json/%s/%s", API_KEY, path)
tsdb_get <- function(path, query = list()) {
req  <- request(base_url(path)) |> req_url_query(!!!query)
resp <- req |> req_perform()
fromJSON(resp_body_string(resp), flatten = TRUE)
}
# --- today in your timezone
today_local <- as.Date(with_tz(Sys.time(), TZ_OUT))
today_str   <- format(today_local, "%Y-%m-%d")
# Pull adjacent API days to avoid UTC boundary issues
api_days <- c(today_local - 1, today_local, today_local + 1) |> format("%Y-%m-%d")
sports_to_pull <- c("Soccer", "Baseball", "Basketball", "American Football", "Ice Hockey")
get_events_day_sport <- function(day_yyyy_mm_dd, sport) {
x <- tsdb_get("eventsday.php", query = list(d = day_yyyy_mm_dd, s = sport))
if (is.null(x$events)) return(tibble())
as_tibble(x$events) |>
mutate(api_day = day_yyyy_mm_dd, request_sport = sport)
}
raw <- map_dfr(api_days, \(d) map_dfr(sports_to_pull, \(s) get_events_day_sport(d, s)))
if (nrow(raw) == 0) stop("No events returned by TheSportsDB for: ", paste(api_days, collapse = ", "))
# --- keep only your leagues (tolerant matching)
keep_league <- function(x) {
x <- str_to_lower(str_squish(x))
str_detect(x, "premier league") |
str_detect(x, "bundesliga") |
str_detect(x, "uefa.*champions league|\\bchampions league\\b") |
str_detect(x, "\\bnfl\\b|national football league") |
str_detect(x, "\\bnba\\b|national basketball association") |
str_detect(x, "\\bnhl\\b|national hockey league") |
str_detect(x, "\\bmlb\\b|major league baseball")
}
raw <- raw |>
mutate(strLeague = if ("strLeague" %in% names(raw)) strLeague else NA_character_) |>
filter(!is.na(strLeague) & keep_league(strLeague))
if (nrow(raw) == 0) stop("No matching league events found for: ", today_str)
# --- Parse event datetime as UTC, then convert to TZ_OUT
# TheSportsDB is inconsistent; prefer strTimestamp, else dateEvent+strTime.
dt_utc <- rep(as.POSIXct(NA, tz = "UTC"), nrow(raw))
if ("strTimestamp" %in% names(raw)) {
tmp <- ymd_hms(raw$strTimestamp, tz = "UTC", quiet = TRUE)
dt_utc[!is.na(tmp)] <- tmp[!is.na(tmp)]
}
if (all(is.na(dt_utc)) && all(c("dateEvent", "strTime") %in% names(raw))) {
tmp <- ymd_hms(paste(raw$dateEvent, raw$strTime), tz = "UTC", quiet = TRUE)
dt_utc <- tmp
}
# convert to your timezone
dt_local <- with_tz(dt_utc, TZ_OUT)
# CRITICAL: compute local date using explicit tz
date_local <- as.Date(dt_local, tz = TZ_OUT)
schedule_today <- tibble(
league   = raw$strLeague,
sport    = if ("strSport" %in% names(raw)) raw$strSport else raw$request_sport,
datetime = dt_local,
date     = date_local,
time     = ifelse(is.na(dt_local), NA_character_, format(dt_local, "%H:%M")),
home     = if ("strHomeTeam" %in% names(raw)) raw$strHomeTeam else NA_character_,
away     = if ("strAwayTeam" %in% names(raw)) raw$strAwayTeam else NA_character_,
event    = coalesce(if ("strEvent" %in% names(raw)) raw$strEvent else NA_character_,
paste(home, "vs", away)),
venue    = if ("strVenue" %in% names(raw)) raw$strVenue else NA_character_,
idEvent  = if ("idEvent" %in% names(raw)) raw$idEvent else NA_character_,
api_day  = raw$api_day
) |>
# keep only games that are TODAY in your timezone
filter(date == today_local) |>
# dedupe across the 3-day pull
arrange(league, datetime, event) |>
distinct(coalesce(idEvent, paste(league, datetime, event)), .keep_all = TRUE) |>
select(league, sport, datetime, date, time, home, away, event, venue) |>
arrange(league, datetime, event)
print(schedule_today, n = 500)
# If you want to see what got excluded (yesterday/tomorrow spillover), run:
# excluded <- tibble(league=raw$strLeague, dt_local=dt_local, date_local=date_local, event=coalesce(raw$strEvent, "")) |>
#   filter(date_local != today_local) |>
#   arrange(date_local, league, dt_local)
# print(excluded, n=200)
View(schedule_today)
#sportsScheduler Interface
#January 2026
#J Stalnaker
#Load requisite packages
source("packages.R")
API_KEY <- "123"
TZ_OUT  <- "America/Los_Angeles"
base_url <- function(path) sprintf("https://www.thesportsdb.com/api/v1/json/%s/%s", API_KEY, path)
tsdb_get <- function(path, query = list()) {
req  <- request(base_url(path)) |> req_url_query(!!!query)
resp <- req |> req_perform()
fromJSON(resp_body_string(resp), flatten = TRUE)
}
# --- today in your timezone
today_local <- as.Date(with_tz(Sys.time(), TZ_OUT))
today_str   <- format(today_local, "%Y-%m-%d")
# Pull adjacent API days to avoid UTC boundary issues
api_days <- format(c(today_local - 1, today_local, today_local + 1), "%Y-%m-%d")
sports_to_pull <- c("Soccer", "Baseball", "Basketball", "American Football", "Ice Hockey")
get_events_day_sport <- function(day_yyyy_mm_dd, sport) {
x <- tsdb_get("eventsday.php", query = list(d = day_yyyy_mm_dd, s = sport))
if (is.null(x$events)) return(tibble())
as_tibble(x$events) |>
mutate(api_day = day_yyyy_mm_dd, request_sport = sport)
}
raw <- map_dfr(api_days, \(d) map_dfr(sports_to_pull, \(s) get_events_day_sport(d, s)))
if (nrow(raw) == 0) stop("No events returned by TheSportsDB for: ", paste(api_days, collapse = ", "))
# --- keep only your leagues (tolerant matching)
keep_league <- function(x) {
x <- str_to_lower(str_squish(x))
str_detect(x, "premier league") |
str_detect(x, "bundesliga") |
str_detect(x, "uefa.*champions league|\\bchampions league\\b") |
str_detect(x, "\\bnfl\\b|national football league") |
str_detect(x, "\\bnba\\b|national basketball association") |
str_detect(x, "\\bnhl\\b|national hockey league") |
str_detect(x, "\\bmlb\\b|major league baseball")
}
raw <- raw |>
mutate(strLeague = if ("strLeague" %in% names(raw)) strLeague else NA_character_) |>
filter(!is.na(strLeague) & keep_league(strLeague))
if (nrow(raw) == 0) stop("No matching league events found for local date: ", today_str)
# --- Parse datetime as UTC, then convert to TZ_OUT
dt_utc <- rep(as.POSIXct(NA, tz = "UTC"), nrow(raw))
if ("strTimestamp" %in% names(raw)) {
tmp <- ymd_hms(raw$strTimestamp, tz = "UTC", quiet = TRUE)
dt_utc[!is.na(tmp)] <- tmp[!is.na(tmp)]
}
if (all(is.na(dt_utc)) && all(c("dateEvent", "strTime") %in% names(raw))) {
tmp <- ymd_hms(paste(raw$dateEvent, raw$strTime), tz = "UTC", quiet = TRUE)
dt_utc <- tmp
}
dt_local  <- with_tz(dt_utc, TZ_OUT)
date_local <- as.Date(dt_local, tz = TZ_OUT)
schedule_today <- tibble(
league   = raw$strLeague,
sport    = if ("strSport" %in% names(raw)) raw$strSport else raw$request_sport,
datetime = dt_local,
date     = date_local,
time     = ifelse(is.na(dt_local), NA_character_, format(dt_local, "%H:%M")),
home     = if ("strHomeTeam" %in% names(raw)) raw$strHomeTeam else NA_character_,
away     = if ("strAwayTeam" %in% names(raw)) raw$strAwayTeam else NA_character_,
event    = coalesce(if ("strEvent" %in% names(raw)) raw$strEvent else NA_character_,
paste(home, "vs", away)),
venue    = if ("strVenue" %in% names(raw)) raw$strVenue else NA_character_,
idEvent  = if ("idEvent" %in% names(raw)) raw$idEvent else NA_character_
) |>
filter(date == today_local) |>
arrange(league, datetime, event) |>
distinct(coalesce(idEvent, paste(league, datetime, event)), .keep_all = TRUE) |>
select(league, sport, date, time, home, away, event, venue) |>
arrange(league, time, event)
print(schedule_today, n = 500)
# --- Dump to Excel
out_file <- paste0("schedule_", today_str, ".xlsx")
writexl::write_xlsx(schedule_today, out_file)
message("Wrote: ", out_file)
out_file <- paste0("schedule_", today_str, ".xlsx")
wb <- createWorkbook()
addWorksheet(wb, "Schedule")
#Load requisite packages
source("packages.R")
#sportsScheduler Interface
#January 2026
#J Stalnaker
#Load requisite packages
source("packages.R")
# Daily “what’s on” schedule for:
# EPL, Bundesliga, UEFA Champions League, MLB, NBA, NFL, NHL
API_KEY <- "123"
TZ_OUT  <- "America/Los_Angeles"
base_url <- function(path) sprintf("https://www.thesportsdb.com/api/v1/json/%s/%s", API_KEY, path)
tsdb_get <- function(path, query = list()) {
req  <- request(base_url(path)) |> req_url_query(!!!query)
resp <- req |> req_perform()
fromJSON(resp_body_string(resp), flatten = TRUE)
}
# --- today in your timezone
today_local <- as.Date(with_tz(Sys.time(), TZ_OUT))
today_str   <- format(today_local, "%Y-%m-%d")
# Pull adjacent API days to avoid UTC boundary issues
api_days <- format(c(today_local - 1, today_local, today_local + 1), "%Y-%m-%d")
sports_to_pull <- c("Soccer", "Baseball", "Basketball", "American Football", "Ice Hockey")
get_events_day_sport <- function(day_yyyy_mm_dd, sport) {
x <- tsdb_get("eventsday.php", query = list(d = day_yyyy_mm_dd, s = sport))
if (is.null(x$events)) return(tibble())
as_tibble(x$events) |>
mutate(api_day = day_yyyy_mm_dd, request_sport = sport)
}
raw <- map_dfr(api_days, \(d) map_dfr(sports_to_pull, \(s) get_events_day_sport(d, s)))
if (nrow(raw) == 0) stop("No events returned by TheSportsDB for: ", paste(api_days, collapse = ", "))
# --- keep only your leagues (tolerant matching)
keep_league <- function(x) {
x <- str_to_lower(str_squish(x))
str_detect(x, "premier league") |
str_detect(x, "bundesliga") |
str_detect(x, "uefa.*champions league|\\bchampions league\\b") |
str_detect(x, "\\bnfl\\b|national football league") |
str_detect(x, "\\bnba\\b|national basketball association") |
str_detect(x, "\\bnhl\\b|national hockey league") |
str_detect(x, "\\bmlb\\b|major league baseball")
}
raw <- raw |>
mutate(strLeague = if ("strLeague" %in% names(raw)) strLeague else NA_character_) |>
filter(!is.na(strLeague) & keep_league(strLeague))
if (nrow(raw) == 0) stop("No matching league events found for local date: ", today_str)
# --- Parse datetime as UTC, then convert to TZ_OUT
dt_utc <- rep(as.POSIXct(NA, tz = "UTC"), nrow(raw))
if ("strTimestamp" %in% names(raw)) {
tmp <- ymd_hms(raw$strTimestamp, tz = "UTC", quiet = TRUE)
dt_utc[!is.na(tmp)] <- tmp[!is.na(tmp)]
}
if (all(is.na(dt_utc)) && all(c("dateEvent", "strTime") %in% names(raw))) {
tmp <- ymd_hms(paste(raw$dateEvent, raw$strTime), tz = "UTC", quiet = TRUE)
dt_utc <- tmp
}
dt_local   <- with_tz(dt_utc, TZ_OUT)
date_local <- as.Date(dt_local, tz = TZ_OUT)
schedule_today <- tibble(
league   = raw$strLeague,
sport    = if ("strSport" %in% names(raw)) raw$strSport else raw$request_sport,
datetime = dt_local,
date     = date_local,
time     = ifelse(is.na(dt_local), NA_character_, format(dt_local, "%H:%M")),
home     = if ("strHomeTeam" %in% names(raw)) raw$strHomeTeam else NA_character_,
away     = if ("strAwayTeam" %in% names(raw)) raw$strAwayTeam else NA_character_,
event    = coalesce(if ("strEvent" %in% names(raw)) raw$strEvent else NA_character_,
paste(home, "vs", away)),
venue    = if ("strVenue" %in% names(raw)) raw$strVenue else NA_character_,
idEvent  = if ("idEvent" %in% names(raw)) raw$idEvent else NA_character_
) |>
filter(date == today_local) |>
arrange(league, datetime, event) |>
distinct(coalesce(idEvent, paste(league, datetime, event)), .keep_all = TRUE) |>
select(league, sport, date, time, home, away, event, venue) |>
arrange(league, time, event)
print(schedule_today, n = 500)
# =========================================================
# EXCEL OUTPUT (formatted)
# - auto-sized columns
# - bold header + filters
# - freeze header row
# =========================================================
out_file <- paste0("schedule_", today_str, ".xlsx")
wb <- createWorkbook()
addWorksheet(wb, "Schedule")
writeData(wb, "Schedule", schedule_today, withFilter = TRUE)
# Header styling
header_style <- createStyle(textDecoration = "bold")
addStyle(
wb, "Schedule", header_style,
rows = 1, cols = 1:ncol(schedule_today),
gridExpand = TRUE, stack = TRUE
)
# Freeze header row
freezePane(wb, "Schedule", firstRow = TRUE)
# Auto-size columns
setColWidths(wb, "Schedule", cols = 1:ncol(schedule_today), widths = "auto")
saveWorkbook(wb, out_file, overwrite = TRUE)
message("Wrote: ", out_file)
